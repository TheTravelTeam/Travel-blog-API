# Password Reset Token - documentation du flux

## Aperçu fonctionnel
- `POST /auth/forgot-password` reçoit l'email, répond `204` après avoir déclenché la génération d'un jeton même si le compte est absent.
- `PasswordResetService.requestPasswordReset` normalise l'email, cherche l'utilisateur, supprime ses anciens jetons, en crée un nouveau et l'envoie par email.
- L'utilisateur clique sur le lien `https://<front>/reset-password?token=...` reçu par mail.
- `POST /auth/reset-password` reçoit le jeton et le nouveau mot de passe puis redirige vers `PasswordResetService.resetPassword`.
- Le service vérifie la validité/expiration, met à jour le mot de passe du `User` et supprime les jetons restants.

## Chaînage des composants Spring
- `AuthController` (src/main/java/com/wcs/travel_blog/auth/controller/AuthController.java) expose `/auth/forgot-password` et délègue au service.
- `PasswordResetController` (src/main/java/com/wcs/travel_blog/auth/controller/PasswordResetController.java) gère `/auth/reset-password` côté back-office.
- `PasswordResetService` (src/main/java/com/wcs/travel_blog/auth/service/PasswordResetService.java) orchestre la création, la validation et la purge des jetons.
- `PasswordResetTokenRepository` (src/main/java/com/wcs/travel_blog/auth/repository/PasswordResetTokenRepository.java) fournit les opérations de persistance.
- `PasswordResetToken` (src/main/java/com/wcs/travel_blog/auth/model/PasswordResetToken.java) matérialise l'entité JPA liée à `User`.
- `User` (src/main/java/com/wcs/travel_blog/user/model/User.java) représente le propriétaire du compte et détient le mot de passe encodé.

## Vie d'un token
### Création
1. Normalisation de l'email (`trim + lowercase`).
2. Recherche de l'utilisateur ; si absent, on coupe le flux après un log pour éviter une fuite d'information.
3. Suppression des jetons existants via `passwordResetTokenRepository.deleteByUser(user)`.
4. Génération d'un UUID, calcul de `expiresAt = now + ttl` et construction du lien front.
5. Sauvegarde du token : `passwordResetTokenRepository.save(new PasswordResetToken(token, user, expiresAt, now))`.
6. Envoi du mail via `MailService` avec le lien signé.

### Validation & consommation
1. Vérification que le jeton est renseigné (`InvalidPasswordResetTokenException` sinon).
2. Récupération en base par `findByToken` ; exception si absent.
3. Contrôle d'expiration (`ExpiredPasswordResetTokenException` si `expiresAt < now`).
4. Encodage et sauvegarde du nouveau mot de passe sur `User`.
5. Purge des jetons restants du compte (`deleteByUser`).

## Modélisation des données (Merise)
### MCD (Modèle Conceptuel de Données)
```text
[Utilisateur]
  - id
  - email
  - passwordHash
  - updatedAt
    1,1 --- possede --- 0,n
[TokenReinitialisation]
  - token
  - createdAt
  - expiresAt
```

### MLD (Modèle Logique de Données)
```text
UTILISATEUR (PK id, email UNIQUE, password_hash, updated_at, ...)
PASSWORD_RESET_TOKEN (PK id, token UNIQUE, expires_at, created_at, FK user_id -> UTILISATEUR.id)
Contraintes :
- CARD(UTILISATEUR, PASSWORD_RESET_TOKEN) = 1,N côté utilisateur, 0,1 côté jeton.
- Suppression en cascade gérée applicativement (purge des jetons avant création/reset).
```

### MPD (Modèle Physique de Données)
```sql
CREATE TABLE user (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP,
    -- autres colonnes...
);

CREATE TABLE password_reset_token (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    token VARCHAR(128) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_password_reset_token_user
        FOREIGN KEY (user_id) REFERENCES user(id)
        ON DELETE CASCADE
);
```

## Ressources associées
- Tests d'intégration : `src/test/java/com/wcs/travel_blog/auth/controller/PasswordResetControllerIT.java`.
- Séquence générale : `docs/auth-forgot-password.md`.
- Pour la mise à jour des schémas Merise, placer les diagrammes exportés dans `docs/diagrams/password-reset/` (PNG/SVG ou `.drawio`).
